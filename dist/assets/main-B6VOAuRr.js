(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const D="modulepreload",Y=function(e){return"/"+e},B={},z=function(t,n,s){let a=Promise.resolve();if(n&&n.length>0){let l=function(i){return Promise.all(i.map(d=>Promise.resolve(d).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));a=l(n.map(i=>{if(i=Y(i),i in B)return;B[i]=!0;const d=i.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${m}`))return;const u=document.createElement("link");if(u.rel=d?"stylesheet":D,d||(u.as="script"),u.crossOrigin="",u.href=i,c&&u.setAttribute("nonce",c),document.head.appendChild(u),d)return new Promise((f,h)=>{u.addEventListener("load",f),u.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${i}`)))})}))}function r(l){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=l,window.dispatchEvent(o),!o.defaultPrevented)throw l}return a.then(l=>{for(const o of l||[])o.status==="rejected"&&r(o.reason);return t().catch(r)})},x="https://vikings-osm-event-manager.onrender.com";console.log("Using Backend URL:",x);function K(e,t){if(e&&e._rateLimitInfo){const n=e._rateLimitInfo;if(n.osm){const s=n.osm,a=s.limit>0?((s.limit-s.remaining)/s.limit*100).toFixed(1):0;console.group(`🔄 ${t} Rate Limit Status`),console.log("📊 OSM API:",{remaining:`${s.remaining}/${s.limit}`,percentUsed:`${a}%`,window:s.window||"per hour",available:s.available,rateLimited:s.rateLimited||!1}),s.remaining<20&&s.limit>0&&console.warn(`⚠️ OSM rate limit warning for ${t}: Only ${s.remaining} requests remaining (${a}% used)!`),s.remaining<10&&s.limit>0&&console.error(`🚨 CRITICAL: Only ${s.remaining} OSM requests remaining for ${t}! (${a}% used)`)}if(n.backend){const s=n.backend,a=s.limit>0?((s.limit-s.remaining)/s.limit*100).toFixed(1):0;console.log("🖥️ Backend API:",{remaining:`${s.remaining}/${s.limit}`,percentUsed:`${a}%`,window:s.window||"per minute"})}console.groupEnd()}else console.log(`📊 ${t}: No rate limit info available`)}async function I(e,t){if(e.status===429){const n=await e.json().catch(()=>({}));if(n.rateLimitInfo){const s=n.rateLimitInfo.retryAfter||"unknown time";throw console.warn(`🚫 ${t} rate limited by OSM. Backend managing retry. Wait: ${s}s`),n.rateLimitInfo.retryAfter?new Error(`OSM API rate limit exceeded. Please wait ${n.rateLimitInfo.retryAfter} seconds before trying again.`):new Error("OSM API rate limit exceeded. Please wait before trying again.")}else throw console.warn(`🚫 ${t} rate limited. Backend managing request flow.`),new Error("Rate limited. The backend is managing request flow to prevent blocking.")}if(e.status===401||e.status===403)return console.warn(`🔐 Authentication error on ${t}: ${e.status}`),b(),null;if(!e.ok){const n=await e.json().catch(()=>({})),s=n.message||n.error||`HTTP ${e.status}`;if(s&&typeof s=="string"){const a=s.toLowerCase();if(a.includes("blocked")||a.includes("permanently blocked"))throw console.error(`🚨 CRITICAL: OSM API BLOCKED on ${t}!`,s),sessionStorage.setItem("osm_blocked","true"),new Error(`OSM API BLOCKED: ${s}`)}throw console.error(`❌ ${t} API error:`,s),new Error(`${t} failed: ${s}`)}try{const n=await e.json();return K(n,t),ye(n)?n:(console.warn(`🔐 Token invalid in ${t} response`),b(),null)}catch{throw console.error(`❌ ${t} returned invalid JSON`),new Error(`${t} returned invalid response`)}}async function _(e){try{const t=S();if(!t)return b(),null;const n=await fetch(`${x}/get-terms`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:t,sectionid:e})}),s=await I(n,"getMostRecentTermId");if(!s)return null;console.log("Terms API response for section",e,":",s);let a=null;if(s.items&&Array.isArray(s.items))a=s.items;else if(s[e]&&Array.isArray(s[e]))a=s[e];else if(Array.isArray(s))a=s;else return console.warn("Unexpected terms response format:",s),null;if(!a||a.length===0)return console.warn("No terms found for section:",e),null;const l=a.sort((o,c)=>{const i=new Date(o.startdate);return new Date(c.startdate)-i})[0];return console.log("Most recent term found for section",e,":",l),l.termid}catch(t){return console.error("Error fetching most recent term ID:",t),null}}async function M(){try{const e=S();if(!e)return b(),[];const t=await fetch(`${x}/get-user-roles`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:e})}),n=await I(t,"getUserRoles");if(!n)return[];const{_rateLimitInfo:s,...a}=n;return Object.values(a)}catch(e){throw console.error("Error fetching user roles:",e),e}}async function G(e,t){try{const n=S();if(!n)return b(),{items:[]};const s=await fetch(`${x}/get-events`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:n,sectionid:e,termid:t})});return await I(s,"getEvents")||{items:[]}}catch(n){throw console.error("Error fetching events:",n),n}}async function V(e,t,n){try{const s=S();if(!s)return b(),{items:[]};console.log("API call with params:",{sectionId:e,eventId:t,termId:n});const a=await fetch(`${x}/get-event-attendance`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({access_token:s,sectionid:e,eventid:t,termid:n})});console.log("API response status:",a.status);const r=await I(a,"getEventAttendance");return console.log("API response data:",r),r||{items:[]}}catch(s){throw console.error("Error fetching event attendance:",s),s}}function J(e){switch(e==null?void 0:e.toLowerCase()){case"yes":case"attended":case"present":return"success";case"no":case"absent":case"not attended":return"danger";case"maybe":case"unknown":return"warning";default:return"secondary"}}function R(){document.querySelectorAll(".summary-person-row").forEach(e=>{e.addEventListener("click",function(){const t=this.dataset.personIdx,n=document.getElementById(`summary-person-details-${t}`),s=this.querySelector(".summary-expand-icon");n.style.display==="none"?(n.style.display="",s.textContent="▲",this.classList.add("expanded")):(n.style.display="none",s.textContent="▼",this.classList.remove("expanded"))})})}function W(e){const t=document.querySelectorAll("#summary-attendance-table .sortable");let n={column:null,direction:"asc"};t.forEach(s=>{s.addEventListener("click",function(){const a=this.dataset.sort,r=document.getElementById("summary-attendance-tbody"),l=Array.from(r.querySelectorAll(".summary-person-row"));n.column===a?n.direction=n.direction==="asc"?"desc":"asc":n.direction="asc",n.column=a,t.forEach(o=>o.classList.remove("sort-asc","sort-desc")),this.classList.add(n.direction==="asc"?"sort-asc":"sort-desc"),l.sort((o,c)=>{let i=0;switch(a){case"firstname":i=o.dataset.firstname.toLowerCase().localeCompare(c.dataset.firstname.toLowerCase());break;case"lastname":i=o.dataset.lastname.toLowerCase().localeCompare(c.dataset.lastname.toLowerCase());break;case"name":const d=o.dataset.lastname.toLowerCase().localeCompare(c.dataset.lastname.toLowerCase());d!==0?i=d:i=o.dataset.firstname.toLowerCase().localeCompare(c.dataset.firstname.toLowerCase());break;case"status":const m=parseInt(o.dataset.totalYes)||0,u=parseInt(o.dataset.totalNo)||0,f=parseInt(c.dataset.totalYes)||0,h=parseInt(c.dataset.totalNo)||0,A=m+u,E=f+h,g=A>0?m/A:0,k=E>0?f/E:0;g<k?i=-1:g>k?i=1:m<f?i=-1:m>f?i=1:i=0;break;default:return 0}return n.direction==="asc"?i:-i}),l.forEach((o,c)=>{const i=o.dataset.personIdx,d=document.getElementById(`summary-person-details-${i}`);r.appendChild(o),d&&r.appendChild(d)}),R()})})}function X(e,t){const n=document.getElementById("summary-section-filter"),s=document.getElementById("summary-event-filter"),a=document.getElementById("summary-status-filter"),r=document.getElementById("summary-name-filter"),l=document.getElementById("summary-clear-filters-btn");function o(){const c=n.value.toLowerCase(),i=s.value.toLowerCase(),d=a.value.toLowerCase(),m=r.value.toLowerCase();let u=0;document.querySelectorAll(".summary-person-row").forEach(f=>{const h=f.dataset.personIdx,E=Object.keys(e)[h],g=e[E];if(!g){f.style.display="none";const p=document.getElementById(`summary-person-details-${h}`);p&&(p.style.display="none");return}const k=!m||g.firstname.toLowerCase().includes(m)||g.lastname.toLowerCase().includes(m),H=g.events.some(p=>(!c||p.sectionname.toLowerCase().includes(c))&&(!i||p._eventName.toLowerCase().includes(i))&&(!d||p.attending.toLowerCase().includes(d))),L=document.getElementById(`summary-person-details-${h}`);if(k&&H){f.style.display="",L&&(L.style.display="none"),f.classList.remove("expanded");const p=f.querySelector(".summary-expand-icon");p&&(p.textContent="▼"),u++}else f.style.display="none",L&&(L.style.display="none")}),document.getElementById("summary-attendee-count").textContent=u}[n,s,a,r].forEach(c=>{c&&(c.addEventListener("change",o),c.addEventListener("input",o))}),l&&l.addEventListener("click",()=>{[n,s,a,r].forEach(c=>{c&&(c.value="")}),o()})}function Q(e){const t=document.getElementById("summary-content");if(!t)return;if(e.length===0){t.innerHTML='<p class="text-muted text-center">No attendees found.</p>';return}const n={};e.forEach(c=>{const i=`${c.firstname} ${c.lastname}`;n[i]||(n[i]={firstname:c.firstname,lastname:c.lastname,events:[],totalYes:0,totalNo:0}),n[i].events.push(c),c.attending==="Yes"?n[i].totalYes++:c.attending==="No"&&n[i].totalNo++});const s=[...new Set(e.map(c=>c.sectionname))].sort(),a=[...new Set(e.map(c=>c._eventName))].sort(),r=[...new Set(e.map(c=>c.attending))].sort(),l=window.innerWidth<=767;let o=`<div class="d-flex justify-content-between align-items-center mb-3"><h6 class="mb-0">Attendance Summary</h6><small class="text-muted"><span id="summary-attendee-count">${Object.keys(n).length}</span> person(s), <span id="summary-event-count">${e.length}</span> record(s)</small></div>`;o+=`<div class="row mb-3"><div class="col-md-3 mb-2"><select id="summary-section-filter" class="form-select form-select-sm"><option value="">All Sections</option>${s.map(c=>`<option value="${c}">${c}</option>`).join("")}</select></div><div class="col-md-3 mb-2"><select id="summary-event-filter" class="form-select form-select-sm"><option value="">All Events</option>${a.map(c=>`<option value="${c}">${c}</option>`).join("")}</select></div><div class="col-md-3 mb-2"><select id="summary-status-filter" class="form-select form-select-sm"><option value="">All Statuses</option>${r.map(c=>`<option value="${c}">${c}</option>`).join("")}</select></div><div class="col-md-3 mb-2"><input type="text" id="summary-name-filter" class="form-control form-control-sm" placeholder="Search name..."></div></div>`,o+='<div class="mb-3"><button id="summary-clear-filters-btn" class="btn btn-outline-secondary btn-sm">Clear Filters</button></div><div class="table-responsive"><table id="summary-attendance-table" class="table table-striped table-sm">',l?o+='<thead><tr><th style="width: 70px;" class="text-center sortable" data-sort="status">Status <span class="sort-arrow">⇅</span></th><th class="sortable" data-sort="name">Name <span class="sort-arrow">⇅</span></th><th style="width: 40px;" class="text-center">▼</th></tr></thead><tbody id="summary-attendance-tbody">':o+='<thead><tr><th style="width: 120px;" class="text-center sortable" data-sort="status">Attending <span class="sort-arrow">⇅</span></th><th class="sortable" data-sort="firstname">First Name <span class="sort-arrow">⇅</span></th><th class="sortable" data-sort="lastname">Last Name <span class="sort-arrow">⇅</span></th><th style="width: 40px;" class="text-center">▼</th></tr></thead><tbody id="summary-attendance-tbody">',Object.entries(n).forEach(([c,i],d)=>{l?o+=`<tr class="summary-person-row" data-person-idx="${d}" data-firstname="${i.firstname}" data-lastname="${i.lastname}" data-total-yes="${i.totalYes}" data-total-no="${i.totalNo}" style="cursor: pointer;"><td class="text-center total-column"><div class="d-flex flex-column"><span class="text-success fw-bold">${i.totalYes}</span><span class="text-danger small">${i.totalNo}</span></div></td><td><div class="fw-bold">${i.firstname} ${i.lastname}</div><small class="text-muted">${i.events.length} event(s)</small></td><td class="text-center"><span class="summary-expand-icon">▼</span></td></tr>`:o+=`<tr class="summary-person-row" data-person-idx="${d}" data-firstname="${i.firstname}" data-lastname="${i.lastname}" data-total-yes="${i.totalYes}" data-total-no="${i.totalNo}" style="cursor: pointer;"><td class="text-center"><span class="text-success fw-bold">${i.totalYes}</span> / <span class="text-danger">${i.totalNo}</span></td><td>${i.firstname}</td><td>${i.lastname}</td><td class="text-center"><span class="summary-expand-icon">▼</span></td></tr>`,o+=`<tr class="summary-person-details-row" id="summary-person-details-${d}" style="display: none;"><td colspan="${l?3:4}" class="bg-light p-0"><div class="table-responsive"><table class="table table-sm mb-0"><thead class="bg-secondary text-white"><tr><th class="small">Section</th><th class="small">Event</th><th class="small text-center">Status</th></tr></thead><tbody>`,i.events.forEach(m=>{o+=`<tr><td class="small">${m.sectionname||""}</td><td class="small">${m._eventName||""}</td><td class="small text-center ${m.attending==="Yes"?"text-success":"text-danger"}"><strong>${m.attending||""}</strong></td></tr>`}),o+="</tbody></table></div></td></tr>"}),o+="</tbody></table></div>",t.innerHTML=o,R(),W(),X(n)}function Z(e){const t=document.getElementById("grouped-content");if(!t)return;const n={};e.forEach(l=>{const o=l.attending||l.status||"Unknown";n[o]||(n[o]=[]),n[o].push(l)});const s={Yes:1,No:2,Invited:3},a=Object.keys(n).sort((l,o)=>{const c=s[l]||999,i=s[o]||999;return c!==i?c-i:l.localeCompare(o)});if(a.length===0){t.innerHTML='<div class="text-center py-4"><i class="fas fa-info-circle text-muted" style="font-size: 2rem;"></i><p class="text-muted mt-2">No records.</p></div>';return}const r=[];a.forEach((l,o)=>{const c=n[l],i=o===0,d=`grouped-collapse-${l.replace(/\s+/g,"-").toLowerCase()}`,m=J(l);r.push(`<div class="border-bottom"><div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom cursor-pointer" style="cursor:pointer;" onclick="toggleGroupedSection('${d}')"><h6 class="mb-0"><i class="fas fa-chevron-${i?"down":"right"} me-2" id="icon-${d}"></i><span class="badge badge-${m} me-2">${l}</span><span class="text-muted">${c.length} attendees</span></h6></div>`),r.push(`<div class="collapse ${i?"show":""}" id="${d}"><div class="table-responsive"><table class="table table-sm table-hover mb-0"><thead class="thead-light"><tr><th>Name</th><th>Section</th><th>Event</th><th>Date</th><th>Status</th></tr></thead><tbody>`),c.forEach(u=>{r.push(`<tr><td><strong>${u.firstname||""} ${u.lastname||""}</strong></td><td>${u.sectionname||"-"}</td><td>${u._eventName||"-"}</td><td>${u._eventDate||"-"}</td><td><span class="badge badge-${m}">${l}</span></td></tr>`)}),r.push("</tbody></table></div></div></div>")}),t.innerHTML=r.join("")}function ee(e){const t=document.getElementById("camp-groups-content");if(!t)return;if(e.length===0){t.innerHTML='<div class="text-center py-4"><i class="fas fa-info-circle text-muted" style="font-size:2rem;"></i><p class="text-muted mt-2">No attendees.</p></div>';return}const n={};e.forEach(r=>{const l=`${r.firstname} ${r.lastname}`;n[l]||(n[l]={firstname:r.firstname,lastname:r.lastname,sectionname:r.sectionname})});const s=Object.values(n);let a=`<div class="d-flex justify-content-between align-items-center mb-3 px-3 pt-3"><h6 class="mb-0"><i class="fas fa-campground me-2"></i>Camp Groups</h6><small class="text-muted">${s.length} attendee(s)</small></div><div class="table-responsive"><table class="table table-striped table-sm"><thead class="thead-light"><tr><th>Name</th></tr></thead><tbody>`;s.sort((r,l)=>{const o=r.lastname.localeCompare(l.lastname);return o!==0?o:r.firstname.localeCompare(l.firstname)}),s.forEach(r=>{a+=`<tr><td><strong>${r.firstname} ${r.lastname}</strong><br><small class="text-muted">${r.sectionname||"-"}</small></td></tr>`}),a+='</tbody></table></div><div class="px-3 pb-3"><small class="text-muted"><i class="fas fa-info-circle me-1"></i>Simple list for camp groups.</small></div>',t.innerHTML=a}function te(e){const t=document.getElementById("attendance-panel");if(!t)return;const n=`
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Attendance Records
                        <span class="badge badge-light text-dark ms-2">${e.length} total</span></h5>
                </div>
            </div>
            <div class="card-body p-0">
                <nav>
                    <div class="nav nav-tabs border-bottom" id="nav-tab" role="tablist">
                        <button class="nav-link active" id="nav-summary-tab" data-toggle="tab" data-target="#nav-summary" type="button" role="tab" aria-controls="nav-summary" aria-selected="true" onclick="switchAttendanceTab('summary')">
                            <i class="fas fa-table me-1"></i> Summary
                        </button>
                        <button class="nav-link" id="nav-grouped-tab" data-toggle="tab" data-target="#nav-grouped" type="button" role="tab" aria-controls="nav-grouped" aria-selected="false" onclick="switchAttendanceTab('grouped')">
                            <i class="fas fa-layer-group me-1"></i> Detailed
                        </button>
                        <button class="nav-link" id="nav-camp-groups-tab" data-toggle="tab" data-target="#nav-camp-groups" type="button" role="tab" aria-controls="nav-camp-groups" aria-selected="false" onclick="switchAttendanceTab('camp-groups')">
                            <i class="fas fa-campground me-1"></i> Camp Groups
                        </button>
                    </div>
                </nav>
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-summary" role="tabpanel" aria-labelledby="nav-summary-tab"><div id="summary-content" class="p-0"></div></div>
                    <div class="tab-pane fade" id="nav-grouped" role="tabpanel" aria-labelledby="nav-grouped-tab"><div id="grouped-content" class="p-0"></div></div>
                    <div class="tab-pane fade" id="nav-camp-groups" role="tabpanel" aria-labelledby="nav-camp-groups-tab"><div id="camp-groups-content" class="p-0"></div></div>
                </div>
            </div>
        </div>`;t.innerHTML=n,Q(e),Z(e),ee(e)}function ne(e){document.querySelectorAll("#nav-tab .nav-link").forEach(t=>{t.classList.remove("active"),t.setAttribute("aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(t=>t.classList.remove("show","active")),e==="summary"?(document.getElementById("nav-summary-tab").classList.add("active"),document.getElementById("nav-summary-tab").setAttribute("aria-selected","true"),document.getElementById("nav-summary").classList.add("show","active")):e==="grouped"?(document.getElementById("nav-grouped-tab").classList.add("active"),document.getElementById("nav-grouped-tab").setAttribute("aria-selected","true"),document.getElementById("nav-grouped").classList.add("show","active")):e==="camp-groups"&&(document.getElementById("nav-camp-groups-tab").classList.add("active"),document.getElementById("nav-camp-groups-tab").setAttribute("aria-selected","true"),document.getElementById("nav-camp-groups").classList.add("show","active"))}async function se(e,t){if(sessionStorage.getItem("osm_blocked")==="true"){y("Application is blocked by OSM. Contact administrator."),F();return}if(e.length===0){y("Please select at least one section");return}j();try{let n=[];const s={};t&&Array.isArray(t)&&t.forEach(a=>{s[a.sectionid]=a.sectionname});for(const a of e){const r=await _(a);if(r){const l=await G(a,r);if(l&&l.items){const o=l.items.map(c=>({...c,sectionname:s[a]||"Unknown Section",sectionid:a}));n=n.concat(o)}}}fe(n,a=>ae(a,t),!0)}catch(n){y("Failed to load events"),console.error(n)}finally{U()}}async function ae(e,t){if(!e||e.length===0){y("Please select at least one event");return}j();try{let n=[];for(const s of e)try{console.log("Processing event:",{eventid:s.eventid,sectionid:s.sectionid,termid:s.termid,name:s.name});let a=s.termid;a||(console.warn(`TermID missing for event ${s.name}, attempting to fetch it.`),a=await _(s.sectionid));const r=await V(s.sectionid,s.eventid,a);if(console.log("Raw attendance data for event",s.name,":",r),r&&r.items&&r.items.length>0){const l=r.items.map(o=>({...o,sectionname:s.sectionname,_eventName:s.name,_eventDate:s.date}));n=n.concat(l)}else if(r&&Array.isArray(r)&&r.length>0){const l=r.map(o=>({...o,sectionname:s.sectionname,_eventName:s.name,_eventDate:s.date}));n=n.concat(l)}else console.warn("No attendance data found for event:",s.name,r)}catch(a){console.error(`Failed to fetch attendance for event ${s.name}:`,a)}n.length===0?y("No attendance data found for selected events. Some events might have had issues loading."):te(n)}catch(n){y("Failed to load attendees data"),console.error("Overall error:",n)}finally{U()}}const v="viking_sections_cache",oe=24*60*60*1e3;function re(e){try{const t={sections:e,timestamp:Date.now(),version:"1.0"};localStorage.setItem(v,JSON.stringify(t)),console.log(`Cached ${e.length} sections to localStorage`)}catch(t){console.warn("Failed to cache sections:",t)}}function ie(){try{const e=localStorage.getItem(v);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.timestamp>oe?(console.log("Sections cache expired, removing..."),localStorage.removeItem(v),null):(console.log(`Loaded ${t.sections.length} sections from cache (version: ${t.version||"unknown"})`),t.sections)}catch(e){return console.warn("Failed to load sections from cache:",e),localStorage.removeItem(v),null}}function ce(){localStorage.removeItem(v),console.log("Sections cache cleared")}async function q(){try{let e=ie();return e||(console.log("No cached sections found or cache expired, loading from API..."),e=await M(),e&&e.length>0?(re(e),e):(console.warn("No sections returned from API"),[]))}catch(e){throw console.error("Failed to load sections from cache or API:",e),e}}const w={DOTS:"dots",RING:"ring",GRADIENT:"gradient"};let T=w.DOTS;function le(e){Object.values(w).includes(e)?(T=e,console.log(`Loading animation set to: ${e}`)):console.warn(`Invalid spinner type: ${e}. Using default: ${T}`)}function j(e="Loading...",t=T){const n=document.getElementById("loading-overlay");if(!n){console.warn("Loading overlay not found, creating fallback spinner"),de(e);return}const s=n.querySelector(".loading-text"),a=n.querySelector("#spinner-container");if(s&&(s.textContent=e),a){a.innerHTML="";const r=me(t);a.appendChild(r)}n.style.display="flex",n.style.opacity="0",setTimeout(()=>{n.style.opacity="0.9"},50)}function U(){const e=document.getElementById("loading-overlay");if(!e){const t=document.getElementById("fallback-spinner");t&&document.body.removeChild(t);return}e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300)}function de(e){if(document.getElementById("fallback-spinner"))return;const n=document.createElement("div");n.id="fallback-spinner",n.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column;",n.innerHTML=`<div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem;"></div><div style="color: #6c757d; font-size: 0.9rem;">${e}</div>`,document.body.appendChild(n)}function me(e){const t=document.createElement("div");switch(e){case w.DOTS:t.className="modern-spinner";break;case w.RING:t.className="ring-spinner";break;case w.GRADIENT:t.className="gradient-spinner";break;default:t.className="modern-spinner"}return t}function y(e){const t=document.createElement("div");t.className="error-toast",t.innerHTML=`<div class="error-toast-content"><i class="fas fa-exclamation-circle"></i><span>${e}</span><button class="error-toast-close">&times;</button></div>`,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},5e3),t.querySelector(".error-toast-close").addEventListener("click",()=>{t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)})}function ue(e,t){let n=document.getElementById("sections-table-container");if(!n)return;let s='<div class="mb-3"><div class="d-flex justify-content-end mb-2"><button class="btn btn-outline-secondary btn-sm" onclick="clearSectionsCache(); loadSectionsFromCacheOrAPI();" title="Refresh sections from API"><i class="fas fa-sync"></i></button></div><table id="sections-table" class="table table-striped table-sm"><thead><tr><th style="width: 40px;"></th><th>Section Name</th></tr></thead><tbody>';e.forEach(r=>{const l=r.sectionid||r.id||"unknown",o=r.sectionname||r.name||"Unknown Section";s+=`<tr><td><input type="checkbox" class="section-checkbox" value="${l}"></td><td>${o}</td></tr>`}),s+="</tbody></table></div>",n.innerHTML=s,n.querySelectorAll(".section-checkbox").forEach(r=>{r.addEventListener("change",()=>{const l=Array.from(n.querySelectorAll(".section-checkbox:checked")).map(o=>o.value);if(l.length>0)t(l);else{const o=document.getElementById("events-table-container");o&&(o.innerHTML='<div class="text-center text-muted py-3"><i class="fas fa-calendar-alt"></i><p class="mb-0 mt-2">Select sections to view events</p></div>')}})})}function fe(e,t,n=!1){let s=document.getElementById("events-table-container");if(!s)return;const a=window.innerWidth<=767||n;let r;a?(r='<div class="table-responsive"><table id="events-table" class="table table-striped table-sm"><thead><tr><th style="width: 40px;"></th><th style="width: 70px;" class="text-center">Total</th><th>Event Details</th><th style="width: 40px;"><i class="fas fa-expand-alt" title="Tap rows to expand"></i></th></tr></thead><tbody>',e.forEach((o,c)=>{const i=o.yes||0,d=o.no||0;r+=`<tr>
                <td><input type="checkbox" class="event-checkbox" data-idx="${c}"></td>
                <td class="text-center">
                    <div class="d-flex flex-column">
                        <span class="text-success fw-bold">${i}</span>
                        <span class="text-danger small">${d}</span>
                    </div>
                </td>
                <td>
                    <div class="fw-bold">${o.name||""}</div>
                    <small class="text-muted">${o.sectionname||""}</small>
                    <br><small class="text-muted">${o.date||""}</small>
                </td>
                <td class="text-center">
                    <span class="expand-icon">▼</span>
                </td>
            </tr>`})):(r='<div class="table-responsive"><table id="events-table" class="table table-striped table-sm"><thead><tr><th style="width: 40px;"></th><th style="min-width: 120px;" data-sort="sectionname">Section</th><th style="min-width: 150px;" data-sort="name">Event Name</th><th style="min-width: 100px;" data-sort="date">Date</th><th style="min-width: 60px;" data-sort="yes">Yes</th><th style="min-width: 80px;" data-sort="yes_members">Members</th><th style="min-width: 60px;" data-sort="yes_yls">YLs</th><th style="min-width: 80px;" data-sort="yes_leaders">Leaders</th><th style="min-width: 60px;" data-sort="no">No</th></tr></thead><tbody>',e.forEach((o,c)=>{r+=`<tr>
                <td><input type="checkbox" class="event-checkbox" data-idx="${c}"></td>
                <td class="text-nowrap">${o.sectionname||""}</td>
                <td class="event-name-cell">${o.name||""}</td>
                <td class="text-nowrap">${o.date||""}</td>
                <td class="text-center">${o.yes||0}</td>
                <td class="text-center">${o.yes_members||0}</td>
                <td class="text-center">${o.yes_yls||0}</td>
                <td class="text-center">${o.yes_leaders||0}</td>
                <td class="text-center">${o.no||0}</td>
            </tr>`})),r+="</tbody></table></div>",s.innerHTML=r,s.eventsData=e,s.querySelectorAll(".event-checkbox").forEach(o=>{o.addEventListener("change",()=>{const c=Array.from(s.querySelectorAll(".event-checkbox:checked")).map(i=>e[parseInt(i.dataset.idx)]);c.length>0&&t(c)})})}function pe(){const e=document.querySelector("main");if(!e){console.error("Main container not found");return}if(e.innerHTML='<div class="container-fluid p-0"><div class="row no-gutters"><div class="col-12"><div id="app-content"><div id="attendance-panel" class="mt-4"><div class="card shadow-sm h-100"><div class="card-header bg-info text-white"><h5 class="mb-0">Attendance Details</h5></div><div class="card-body"><p class="text-muted text-center">Use the sidebar to load sections and events, then view attendance details here.</p></div></div></div></div></div></div></div>',he(),!document.querySelector(".sidebar-content")){console.warn("Sidebar content not found, recreating...");const n=document.getElementById("sidebar");n&&(n.innerHTML='<div class="sidebar-header"><h3>Sections & Events</h3></div><div class="sidebar-content"><div id="sections-table-container"></div><div id="events-table-container" class="mt-3"></div></div>')}we(),console.log("Main UI initialized - ready for sidebar interaction")}function he(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarToggle"),n=document.getElementById("sidebarOverlay");if(!e||!t){console.warn("Sidebar elements not found for initialization.");return}function s(){e.classList.remove("open"),document.body.classList.remove("sidebar-open"),n&&n.classList.remove("show"),t.style.left="1rem"}t.addEventListener("click",()=>{e.classList.contains("open")?s():(e.classList.add("open"),document.body.classList.add("sidebar-open"),n&&n.classList.add("show"),t.style.left="340px")}),n&&n.addEventListener("click",s),document.addEventListener("click",a=>{e.classList.contains("open")&&!e.contains(a.target)&&a.target!==t&&!t.contains(a.target)&&s()}),document.addEventListener("keydown",a=>{a.key==="Escape"&&e.classList.contains("open")&&s()})}function $(){const e=document.getElementById("sidebarToggle");if(e){const t=document.body.classList.contains("login-screen");e.style.display=t?"none":"block"}}function F(){var t;const e=document.querySelector("main.container")||document.querySelector("main");if(!e){console.error("Main container not found for blocked screen");return}document.body.classList.add("login-screen"),$(),e.style.display="block",e.className="container",e.innerHTML=`<div class="row justify-content-center"><div class="col-12 col-sm-10 col-md-8 col-lg-6"><div class="card shadow border-danger mb-4"><div class="card-header bg-danger text-white text-center"><h3 class="mb-0">🚨 CRITICAL ERROR</h3></div><div class="card-body text-center p-4"><div class="alert alert-danger mb-4"><h4 class="alert-heading">API Access Blocked!</h4><p class="mb-0">This application has been <strong>blocked by Online Scout Manager</strong> and can no longer access OSM data.</p></div><div class="mb-4"><i class="fas fa-ban text-danger" style="font-size: 4rem;"></i></div><h5 class="text-danger mb-3">Application Suspended</h5><p class="text-muted mb-4">All API functionality has been disabled. <strong>Contact admin.</strong></p><div class="bg-light p-3 rounded mb-4"><small class="text-muted"><strong>Blocked at:</strong> ${new Date().toLocaleString()}<br><strong>Session ID:</strong> ${((t=sessionStorage.getItem("access_token"))==null?void 0:t.substring(0,12))||"N/A"}...</small></div><button onclick="alert('Application is blocked. Contact administrator.')" class="btn btn-danger btn-lg disabled mb-3"><i class="fas fa-ban me-2"></i>Application Blocked</button><div class="mt-3"><small class="text-muted"><a href="#" onclick="if(confirm('Clear blocked status?')) { sessionStorage.removeItem('osm_blocked'); window.location.reload(); }" class="text-secondary">Admin: Clear Blocked Status</a></small></div></div></div></div></div>`}function ge(){const e=document.querySelector("main.container")||document.querySelector("main");if(!e){console.error("Main container not found for loading state");return}e.style.display="block",e.innerHTML='<div class="row justify-content-center"><div class="col-12 col-sm-8 col-md-6 col-lg-4"><div class="card shadow-sm mb-4"><div class="card-body text-center"><div class="spinner-border text-primary mb-3" role="status"><span class="sr-only">Loading...</span></div><p class="text-muted">Loading application...</p></div></div></div></div>'}const N="x7hx1M0NExVdSiksH1gUBPxkSTn8besx",P="section:member:read section:programme:read section:event:read";function S(){return sessionStorage.getItem("access_token")}function ye(e){return!(e&&(e.status===!1&&e.error&&e.error.code==="access-error-2"||e.error==="Invalid access token"||e.message==="Unauthorized"||e.error==="Token expired"))}function b(){if(console.log("Token expired - redirecting to login"),sessionStorage.removeItem("access_token"),localStorage.removeItem("viking_sections_cache"),typeof jest<"u"||typeof window<"u"&&window.navigator&&window.navigator.userAgent==="jsdom"){console.log("Test environment detected - skipping alert and page reload");return}typeof window<"u"&&window.alert&&alert("Your session has expired. Please log in again."),typeof window<"u"&&window.location&&window.location.reload()}function be(){sessionStorage.removeItem("access_token"),console.log("Authentication token cleared")}function O(){console.log("Showing login screen");const e=window.location.origin+"/callback.html",t=document.getElementById("osm-login-btn");if(t){const a=document.querySelector("main.container")||document.querySelector("main");a&&(a.style.display="block"),t.onclick=()=>{const r=`https://www.onlinescoutmanager.co.uk/oauth/authorize?client_id=${N}&redirect_uri=${encodeURIComponent(e)}&scope=${encodeURIComponent(P)}&response_type=code`;window.location.href=r};return}const n=document.querySelector("main.container")||document.querySelector("main");if(!n){console.error("Main container not found for login screen");return}n.style.display="block",n.className="container",n.innerHTML=`
        <div class="row justify-content-center">
            <div class="col-12 col-sm-8 col-md-6 col-lg-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <button id="osm-login-btn"
                            class="btn btn-primary btn-lg mb-3"
                            style="font-size:1.5em; white-space: normal; line-height: 1.2;">
                            Login with<br>Online Scout Manager (OSM)
                        </button>
                        <div id="app-content"></div>
                    </div>
                </div>
            </div>
        </div>
    `;const s=document.getElementById("osm-login-btn");s&&s.addEventListener("click",()=>{const a=`https://www.onlinescoutmanager.co.uk/oauth/authorize?client_id=${N}&redirect_uri=${encodeURIComponent(e)}&scope=${encodeURIComponent(P)}&response_type=code`;window.location.href=a})}async function ve(){if(console.log("Checking for token..."),sessionStorage.getItem("osm_blocked")==="true"){console.error("🚨 Application is blocked - showing blocked screen"),F();return}ge();try{S()?(console.log("Token found, testing validity..."),await M(),console.log("Token is valid, showing main UI"),document.body.classList.remove("login-screen"),$(),pe()):(console.log("No token found, showing login"),document.body.classList.add("login-screen"),$(),O())}catch(e){console.error("Token validation failed:",e),sessionStorage.removeItem("access_token"),document.body.classList.add("login-screen"),$(),O()}}function we(){const e=document.querySelector(".sidebar-content");if(e&&!document.getElementById("logout-btn")){const t=document.createElement("button");t.id="logout-btn",t.className="btn btn-outline-danger btn-sm w-100 mt-3",t.innerHTML='<i class="fas fa-sign-out-alt"></i> Logout',t.onclick=()=>{confirm("Are you sure you want to logout?")&&(be(),window.location.reload())},e.appendChild(t)}}const xe="ring";try{window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"&&z(()=>import("./sentry-CFe3tUzI.js"),[]).catch(e=>{console.warn("Sentry initialization failed:",e)})}catch(e){console.warn("Error monitoring not available:",e)}let C=[];document.addEventListener("DOMContentLoaded",async function(){try{const t=document.querySelector("main.container")||document.querySelector("main");if(t&&(t.style.display="none"),le(xe),!t){console.error("Critical: Main container not found. App cannot start.");return}if(await ve(),!document.body.classList.contains("login-screen")){const n=document.getElementById("sections-table-container");n&&(n.innerHTML='<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> <small class="text-muted ms-2">Loading sections...</small></div>');try{const s=await q();s?(C=s,ue(C,a=>{se(a,C)})):n&&(n.innerHTML='<div class="alert alert-info">No sections found or an issue occurred.</div>')}catch(s){console.error("Error loading sections in main.js:",s),n?n.innerHTML='<div class="alert alert-danger alert-sm"><i class="fas fa-exclamation-triangle"></i> Failed to load sections. <button class="btn btn-outline-primary btn-sm float-end" onclick="window.location.reload()">Retry</button></div>':y("Failed to load sections data. Please try refreshing.")}}}catch(t){console.error("App initialization failed:",t),Se()}});function Se(){const e=document.body;if(e){const t=document.createElement("div");t.innerHTML=`
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        text-align: center; max-width: 400px;">
                <h3 style="color: #dc3545; margin-bottom: 1rem;">Application Error</h3>
                <p style="margin-bottom: 1.5rem;">Failed to load the application. Please refresh the page.</p>
                <button onclick="window.location.reload()" 
                        style="padding: 0.75rem 1.5rem; background: #007bff; color: white; 
                               border: none; border-radius: 4px; cursor: pointer;">
                    Refresh Page
                </button>
            </div>
        `,e.appendChild(t)}}window.switchAttendanceTab=ne;window.clearSectionsCache=ce;window.loadSectionsFromCacheOrAPI=q;
//# sourceMappingURL=main-B6VOAuRr.js.map
