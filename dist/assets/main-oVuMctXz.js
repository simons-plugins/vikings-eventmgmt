(function(){try{var e=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},t=new e.Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="d62db475-3ab8-4591-9b9d-248011ead936",e._sentryDebugIdIdentifier="sentry-dbid-d62db475-3ab8-4591-9b9d-248011ead936")}catch{}})();var Y=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};Y.SENTRY_RELEASE={id:"b79086d54dbfecb026b83803ee40186c70aa8b42"};(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const z="modulepreload",G=function(e){return"/"+e},O={},K=function(t,n,o){let s=Promise.resolve();if(n&&n.length>0){let c=function(i){return Promise.all(i.map(d=>Promise.resolve(d).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));s=c(n.map(i=>{if(i=G(i),i in O)return;O[i]=!0;const d=i.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${m}`))return;const u=document.createElement("link");if(u.rel=d?"stylesheet":z,d||(u.as="script"),u.crossOrigin="",u.href=i,l&&u.setAttribute("nonce",l),document.head.appendChild(u),d)return new Promise((f,p)=>{u.addEventListener("load",f),u.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${i}`)))})}))}function r(c){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=c,window.dispatchEvent(a),!a.defaultPrevented)throw c}return s.then(c=>{for(const a of c||[])a.status==="rejected"&&r(a.reason);return t().catch(r)})},E="https://vikings-osm-event-manager.onrender.com";console.log("Using Backend URL:",E);function W(e,t){if(e&&e._rateLimitInfo){const n=e._rateLimitInfo;if(n.osm){const o=n.osm,s=o.limit>0?((o.limit-o.remaining)/o.limit*100).toFixed(1):0;console.group(`🔄 ${t} Rate Limit Status`),console.log("📊 OSM API:",{remaining:`${o.remaining}/${o.limit}`,percentUsed:`${s}%`,window:o.window||"per hour",available:o.available,rateLimited:o.rateLimited||!1}),o.remaining<20&&o.limit>0&&console.warn(`⚠️ OSM rate limit warning for ${t}: Only ${o.remaining} requests remaining (${s}% used)!`),o.remaining<10&&o.limit>0&&console.error(`🚨 CRITICAL: Only ${o.remaining} OSM requests remaining for ${t}! (${s}% used)`)}if(n.backend){const o=n.backend,s=o.limit>0?((o.limit-o.remaining)/o.limit*100).toFixed(1):0;console.log("🖥️ Backend API:",{remaining:`${o.remaining}/${o.limit}`,percentUsed:`${s}%`,window:o.window||"per minute"})}console.groupEnd()}else console.log(`📊 ${t}: No rate limit info available`)}async function L(e,t){if(e.status===429){const n=await e.json().catch(()=>({}));if(n.rateLimitInfo){const o=n.rateLimitInfo.retryAfter||"unknown time";throw console.warn(`🚫 ${t} rate limited by OSM. Backend managing retry. Wait: ${o}s`),n.rateLimitInfo.retryAfter?new Error(`OSM API rate limit exceeded. Please wait ${n.rateLimitInfo.retryAfter} seconds before trying again.`):new Error("OSM API rate limit exceeded. Please wait before trying again.")}else throw console.warn(`🚫 ${t} rate limited. Backend managing request flow.`),new Error("Rate limited. The backend is managing request flow to prevent blocking.")}if(e.status===401||e.status===403)return console.warn(`🔐 Authentication error on ${t}: ${e.status}`),y(),null;if(!e.ok){const n=await e.json().catch(()=>({})),o=n.message||n.error||`HTTP ${e.status}`;if(o&&typeof o=="string"){const s=o.toLowerCase();if(s.includes("blocked")||s.includes("permanently blocked"))throw console.error(`🚨 CRITICAL: OSM API BLOCKED on ${t}!`,o),sessionStorage.setItem("osm_blocked","true"),new Error(`OSM API BLOCKED: ${o}`)}throw console.error(`❌ ${t} API error:`,o),new Error(`${t} failed: ${o}`)}try{const n=await e.json();return W(n,t),Ee(n)?n:(console.warn(`🔐 Token invalid in ${t} response`),y(),null)}catch{throw console.error(`❌ ${t} returned invalid JSON`),new Error(`${t} returned invalid response`)}}async function J(){try{const e=x();if(!e)return y(),{};const t=await fetch(`${E}/get-terms`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}});return await L(t,"getTerms")||{}}catch(e){throw console.error("Error fetching terms:",e),e}}async function M(e){try{const t=await J();if(!t||!t[e])return console.warn(`No terms found for section ${e}`),null;const n=t[e].reduce((o,s)=>{const r=new Date(s.enddate),c=o?new Date(o.enddate):new Date(0);return r>c?s:o},null);return n?(console.log(`Most recent term found for section ${e}:`,n),n.termid):(console.warn(`No valid term found for section ${e}`),null)}catch(t){throw console.error(`Error fetching most recent term ID for section ${e}:`,t),t}}async function D(){try{const e=x();if(!e)return y(),[];const t=await fetch(`${E}/get-user-roles`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}),n=await L(t,"getUserRoles");return!n||typeof n!="object"?[]:Object.keys(n).filter(s=>!isNaN(s)).map(s=>n[s]).filter(s=>s&&typeof s=="object").map(s=>({sectionid:s.sectionid,sectionname:s.sectionname,section:s.section,isDefault:s.isDefault==="1",permissions:s.permissions}))}catch(e){return console.error("Error fetching user roles:",e),[]}}async function X(e,t){try{const n=x();if(!n)return y(),[];const o=await fetch(`${E}/get-events?sectionid=${e}&termid=${t}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`}});return await L(o,"getEvents")||[]}catch(n){throw console.error(`Error fetching events for section ${e} and term ${t}:`,n),n}}async function Q(e,t,n){try{const o=x();if(!o)return y(),[];const s=await fetch(`${E}/get-event-attendance?sectionid=${e}&termid=${n}&eventid=${t}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`}});return await L(s,"getEventAttendance")||[]}catch(o){throw console.error(`Error fetching event attendance for event ${t}:`,o),o}}function Z(e){switch(e==null?void 0:e.toLowerCase()){case"yes":case"attended":case"present":return"success";case"no":case"absent":case"not attended":return"danger";case"maybe":case"unknown":return"warning";default:return"secondary"}}function U(){document.querySelectorAll(".summary-person-row").forEach(e=>{e.addEventListener("click",function(){const t=this.dataset.personIdx,n=document.getElementById(`summary-person-details-${t}`),o=this.querySelector(".summary-expand-icon");n.style.display==="none"?(n.style.display="",o.textContent="▲",this.classList.add("expanded")):(n.style.display="none",o.textContent="▼",this.classList.remove("expanded"))})})}function ee(e){const t=document.querySelectorAll("#summary-attendance-table .sortable");let n={column:null,direction:"asc"};t.forEach(o=>{o.addEventListener("click",function(){const s=this.dataset.sort,r=document.getElementById("summary-attendance-tbody"),c=Array.from(r.querySelectorAll(".summary-person-row"));n.column===s?n.direction=n.direction==="asc"?"desc":"asc":n.direction="asc",n.column=s,t.forEach(a=>a.classList.remove("sort-asc","sort-desc")),this.classList.add(n.direction==="asc"?"sort-asc":"sort-desc"),c.sort((a,l)=>{let i=0;switch(s){case"firstname":i=a.dataset.firstname.toLowerCase().localeCompare(l.dataset.firstname.toLowerCase());break;case"lastname":i=a.dataset.lastname.toLowerCase().localeCompare(l.dataset.lastname.toLowerCase());break;case"name":const d=a.dataset.lastname.toLowerCase().localeCompare(l.dataset.lastname.toLowerCase());d!==0?i=d:i=a.dataset.firstname.toLowerCase().localeCompare(l.dataset.firstname.toLowerCase());break;case"status":const m=parseInt(a.dataset.totalYes)||0,u=parseInt(a.dataset.totalNo)||0,f=parseInt(l.dataset.totalYes)||0,p=parseInt(l.dataset.totalNo)||0,T=m+u,k=f+p,h=T>0?m/T:0,S=k>0?f/k:0;h<S?i=-1:h>S?i=1:m<f?i=-1:m>f?i=1:i=0;break;default:return 0}return n.direction==="asc"?i:-i}),c.forEach((a,l)=>{const i=a.dataset.personIdx,d=document.getElementById(`summary-person-details-${i}`);r.appendChild(a),d&&r.appendChild(d)}),U()})})}function te(e,t){const n=document.getElementById("summary-section-filter"),o=document.getElementById("summary-event-filter"),s=document.getElementById("summary-status-filter"),r=document.getElementById("summary-name-filter"),c=document.getElementById("summary-clear-filters-btn");function a(){const l=n.value.toLowerCase(),i=o.value.toLowerCase(),d=s.value.toLowerCase(),m=r.value.toLowerCase();let u=0;document.querySelectorAll(".summary-person-row").forEach(f=>{const p=f.dataset.personIdx,k=Object.keys(e)[p],h=e[k];if(!h){f.style.display="none";const g=document.getElementById(`summary-person-details-${p}`);g&&(g.style.display="none");return}const S=!m||h.firstname.toLowerCase().includes(m)||h.lastname.toLowerCase().includes(m),H=h.events.some(g=>(!l||g.sectionname.toLowerCase().includes(l))&&(!i||g._eventName.toLowerCase().includes(i))&&(!d||g.attending.toLowerCase().includes(d))),$=document.getElementById(`summary-person-details-${p}`);if(S&&H){f.style.display="",$&&($.style.display="none"),f.classList.remove("expanded");const g=f.querySelector(".summary-expand-icon");g&&(g.textContent="▼"),u++}else f.style.display="none",$&&($.style.display="none")}),document.getElementById("summary-attendee-count").textContent=u}[n,o,s,r].forEach(l=>{l&&(l.addEventListener("change",a),l.addEventListener("input",a))}),c&&c.addEventListener("click",()=>{[n,o,s,r].forEach(l=>{l&&(l.value="")}),a()})}function ne(e){const t=document.getElementById("summary-content");if(!t)return;if(e.length===0){t.innerHTML='<p class="text-muted text-center">No attendees found.</p>';return}const n={};e.forEach(l=>{const i=`${l.firstname} ${l.lastname}`;n[i]||(n[i]={firstname:l.firstname,lastname:l.lastname,events:[],totalYes:0,totalNo:0}),n[i].events.push(l),l.attending==="Yes"?n[i].totalYes++:l.attending==="No"&&n[i].totalNo++});const o=[...new Set(e.map(l=>l.sectionname))].sort(),s=[...new Set(e.map(l=>l._eventName))].sort(),r=[...new Set(e.map(l=>l.attending))].sort(),c=window.innerWidth<=767;let a=`<div class="d-flex justify-content-between align-items-center mb-3"><h6 class="mb-0">Attendance Summary</h6><small class="text-muted"><span id="summary-attendee-count">${Object.keys(n).length}</span> person(s), <span id="summary-event-count">${e.length}</span> record(s)</small></div>`;a+=`<div class="row mb-3"><div class="col-md-3 mb-2"><select id="summary-section-filter" class="form-select form-select-sm"><option value="">All Sections</option>${o.map(l=>`<option value="${l}">${l}</option>`).join("")}</select></div><div class="col-md-3 mb-2"><select id="summary-event-filter" class="form-select form-select-sm"><option value="">All Events</option>${s.map(l=>`<option value="${l}">${l}</option>`).join("")}</select></div><div class="col-md-3 mb-2"><select id="summary-status-filter" class="form-select form-select-sm"><option value="">All Statuses</option>${r.map(l=>`<option value="${l}">${l}</option>`).join("")}</select></div><div class="col-md-3 mb-2"><input type="text" id="summary-name-filter" class="form-control form-control-sm" placeholder="Search name..."></div></div>`,a+='<div class="mb-3"><button id="summary-clear-filters-btn" class="btn btn-outline-secondary btn-sm">Clear Filters</button></div><div class="table-responsive"><table id="summary-attendance-table" class="table table-striped table-sm">',c?a+='<thead><tr><th style="width: 70px;" class="text-center sortable" data-sort="status">Status <span class="sort-arrow">⇅</span></th><th class="sortable" data-sort="name">Name <span class="sort-arrow">⇅</span></th><th style="width: 40px;" class="text-center">▼</th></tr></thead><tbody id="summary-attendance-tbody">':a+='<thead><tr><th style="width: 120px;" class="text-center sortable" data-sort="status">Attending <span class="sort-arrow">⇅</span></th><th class="sortable" data-sort="firstname">First Name <span class="sort-arrow">⇅</span></th><th class="sortable" data-sort="lastname">Last Name <span class="sort-arrow">⇅</span></th><th style="width: 40px;" class="text-center">▼</th></tr></thead><tbody id="summary-attendance-tbody">',Object.entries(n).forEach(([l,i],d)=>{c?a+=`<tr class="summary-person-row" data-person-idx="${d}" data-firstname="${i.firstname}" data-lastname="${i.lastname}" data-total-yes="${i.totalYes}" data-total-no="${i.totalNo}" style="cursor: pointer;"><td class="text-center total-column"><div class="d-flex flex-column"><span class="text-success fw-bold">${i.totalYes}</span><span class="text-danger small">${i.totalNo}</span></div></td><td><div class="fw-bold">${i.firstname} ${i.lastname}</div><small class="text-muted">${i.events.length} event(s)</small></td><td class="text-center"><span class="summary-expand-icon">▼</span></td></tr>`:a+=`<tr class="summary-person-row" data-person-idx="${d}" data-firstname="${i.firstname}" data-lastname="${i.lastname}" data-total-yes="${i.totalYes}" data-total-no="${i.totalNo}" style="cursor: pointer;"><td class="text-center"><span class="text-success fw-bold">${i.totalYes}</span> / <span class="text-danger">${i.totalNo}</span></td><td>${i.firstname}</td><td>${i.lastname}</td><td class="text-center"><span class="summary-expand-icon">▼</span></td></tr>`,a+=`<tr class="summary-person-details-row" id="summary-person-details-${d}" style="display: none;"><td colspan="${c?3:4}" class="bg-light p-0"><div class="table-responsive"><table class="table table-sm mb-0"><thead class="bg-secondary text-white"><tr><th class="small">Section</th><th class="small">Event</th><th class="small text-center">Status</th></tr></thead><tbody>`,i.events.forEach(m=>{a+=`<tr><td class="small">${m.sectionname||""}</td><td class="small">${m._eventName||""}</td><td class="small text-center ${m.attending==="Yes"?"text-success":"text-danger"}"><strong>${m.attending||""}</strong></td></tr>`}),a+="</tbody></table></div></td></tr>"}),a+="</tbody></table></div>",t.innerHTML=a,U(),ee(),te(n)}function oe(e){const t=document.getElementById("grouped-content");if(!t)return;const n={};e.forEach(c=>{const a=c.attending||c.status||"Unknown";n[a]||(n[a]=[]),n[a].push(c)});const o={Yes:1,No:2,Invited:3},s=Object.keys(n).sort((c,a)=>{const l=o[c]||999,i=o[a]||999;return l!==i?l-i:c.localeCompare(a)});if(s.length===0){t.innerHTML='<div class="text-center py-4"><i class="fas fa-info-circle text-muted" style="font-size: 2rem;"></i><p class="text-muted mt-2">No records.</p></div>';return}const r=[];s.forEach((c,a)=>{const l=n[c],i=a===0,d=`grouped-collapse-${c.replace(/\s+/g,"-").toLowerCase()}`,m=Z(c);r.push(`<div class="border-bottom"><div class="d-flex justify-content-between align-items-center p-3 bg-light border-bottom cursor-pointer" style="cursor:pointer;" onclick="toggleGroupedSection('${d}')"><h6 class="mb-0"><i class="fas fa-chevron-${i?"down":"right"} me-2" id="icon-${d}"></i><span class="badge badge-${m} me-2">${c}</span><span class="text-muted">${l.length} attendees</span></h6></div>`),r.push(`<div class="collapse ${i?"show":""}" id="${d}"><div class="table-responsive"><table class="table table-sm table-hover mb-0"><thead class="thead-light"><tr><th>Name</th><th>Section</th><th>Event</th><th>Date</th><th>Status</th></tr></thead><tbody>`),l.forEach(u=>{r.push(`<tr><td><strong>${u.firstname||""} ${u.lastname||""}</strong></td><td>${u.sectionname||"-"}</td><td>${u._eventName||"-"}</td><td>${u._eventDate||"-"}</td><td><span class="badge badge-${m}">${c}</span></td></tr>`)}),r.push("</tbody></table></div></div></div>")}),t.innerHTML=r.join("")}function se(e){const t=document.getElementById("camp-groups-content");if(!t)return;if(e.length===0){t.innerHTML='<div class="text-center py-4"><i class="fas fa-info-circle text-muted" style="font-size:2rem;"></i><p class="text-muted mt-2">No attendees.</p></div>';return}const n={};e.forEach(r=>{const c=`${r.firstname} ${r.lastname}`;n[c]||(n[c]={firstname:r.firstname,lastname:r.lastname,sectionname:r.sectionname})});const o=Object.values(n);let s=`<div class="d-flex justify-content-between align-items-center mb-3 px-3 pt-3"><h6 class="mb-0"><i class="fas fa-campground me-2"></i>Camp Groups</h6><small class="text-muted">${o.length} attendee(s)</small></div><div class="table-responsive"><table class="table table-striped table-sm"><thead class="thead-light"><tr><th>Name</th></tr></thead><tbody>`;o.sort((r,c)=>{const a=r.lastname.localeCompare(c.lastname);return a!==0?a:r.firstname.localeCompare(c.firstname)}),o.forEach(r=>{s+=`<tr><td><strong>${r.firstname} ${r.lastname}</strong><br><small class="text-muted">${r.sectionname||"-"}</small></td></tr>`}),s+='</tbody></table></div><div class="px-3 pb-3"><small class="text-muted"><i class="fas fa-info-circle me-1"></i>Simple list for camp groups.</small></div>',t.innerHTML=s}function ae(e){const t=document.getElementById("attendance-panel");if(!t)return;const n=`
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Attendance Records
                        <span class="badge badge-light text-dark ms-2">${e.length} total</span></h5>
                </div>
            </div>
            <div class="card-body p-0">
                <nav>
                    <div class="nav nav-tabs border-bottom" id="nav-tab" role="tablist">
                        <button class="nav-link active" id="nav-summary-tab" data-toggle="tab" data-target="#nav-summary" type="button" role="tab" aria-controls="nav-summary" aria-selected="true" onclick="switchAttendanceTab('summary')">
                            <i class="fas fa-table me-1"></i> Summary
                        </button>
                        <button class="nav-link" id="nav-grouped-tab" data-toggle="tab" data-target="#nav-grouped" type="button" role="tab" aria-controls="nav-grouped" aria-selected="false" onclick="switchAttendanceTab('grouped')">
                            <i class="fas fa-layer-group me-1"></i> Detailed
                        </button>
                        <button class="nav-link" id="nav-camp-groups-tab" data-toggle="tab" data-target="#nav-camp-groups" type="button" role="tab" aria-controls="nav-camp-groups" aria-selected="false" onclick="switchAttendanceTab('camp-groups')">
                            <i class="fas fa-campground me-1"></i> Camp Groups
                        </button>
                    </div>
                </nav>
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-summary" role="tabpanel" aria-labelledby="nav-summary-tab"><div id="summary-content" class="p-0"></div></div>
                    <div class="tab-pane fade" id="nav-grouped" role="tabpanel" aria-labelledby="nav-grouped-tab"><div id="grouped-content" class="p-0"></div></div>
                    <div class="tab-pane fade" id="nav-camp-groups" role="tabpanel" aria-labelledby="nav-camp-groups-tab"><div id="camp-groups-content" class="p-0"></div></div>
                </div>
            </div>
        </div>`;t.innerHTML=n,ne(e),oe(e),se(e)}function re(e){document.querySelectorAll("#nav-tab .nav-link").forEach(t=>{t.classList.remove("active"),t.setAttribute("aria-selected","false")}),document.querySelectorAll(".tab-pane").forEach(t=>t.classList.remove("show","active")),e==="summary"?(document.getElementById("nav-summary-tab").classList.add("active"),document.getElementById("nav-summary-tab").setAttribute("aria-selected","true"),document.getElementById("nav-summary").classList.add("show","active")):e==="grouped"?(document.getElementById("nav-grouped-tab").classList.add("active"),document.getElementById("nav-grouped-tab").setAttribute("aria-selected","true"),document.getElementById("nav-grouped").classList.add("show","active")):e==="camp-groups"&&(document.getElementById("nav-camp-groups-tab").classList.add("active"),document.getElementById("nav-camp-groups-tab").setAttribute("aria-selected","true"),document.getElementById("nav-camp-groups").classList.add("show","active"))}async function ie(e,t){if(sessionStorage.getItem("osm_blocked")==="true"){b("Application is blocked by OSM. Contact administrator."),V();return}if(e.length===0){b("Please select at least one section");return}j();try{let n=[];const o={};t&&Array.isArray(t)&&t.forEach(s=>{o[s.sectionid]=s.sectionname});for(const s of e){const r=await M(s);if(r){const c=await X(s,r);if(c&&c.items){const a=c.items.map(l=>({...l,sectionname:o[s]||"Unknown Section",sectionid:s}));n=n.concat(a)}}}be(n,s=>ce(s,t),!0)}catch(n){b("Failed to load events"),console.error(n)}finally{F()}}async function ce(e,t){if(!e||e.length===0){b("Please select at least one event");return}j();try{let n=[];for(const o of e)try{console.log("Processing event:",{eventid:o.eventid,sectionid:o.sectionid,termid:o.termid,name:o.name});let s=o.termid;s||(console.warn(`TermID missing for event ${o.name}, attempting to fetch it.`),s=await M(o.sectionid));const r=await Q(o.sectionid,o.eventid,s);if(console.log("Raw attendance data for event",o.name,":",r),r&&r.items&&r.items.length>0){const c=r.items.map(a=>({...a,sectionname:o.sectionname,_eventName:o.name,_eventDate:o.date}));n=n.concat(c)}else if(r&&Array.isArray(r)&&r.length>0){const c=r.map(a=>({...a,sectionname:o.sectionname,_eventName:o.name,_eventDate:o.date}));n=n.concat(c)}else console.warn("No attendance data found for event:",o.name,r)}catch(s){console.error(`Failed to fetch attendance for event ${o.name}:`,s)}n.length===0?b("No attendance data found for selected events. Some events might have had issues loading."):ae(n)}catch(n){b("Failed to load attendees data"),console.error("Overall error:",n)}finally{F()}}const v="viking_sections_cache",le=24*60*60*1e3;function de(e){try{const t={sections:e,timestamp:Date.now(),version:"1.0"};localStorage.setItem(v,JSON.stringify(t)),console.log(`Cached ${e.length} sections to localStorage`)}catch(t){console.warn("Failed to cache sections:",t)}}function me(){try{const e=localStorage.getItem(v);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.timestamp>le?(console.log("Sections cache expired, removing..."),localStorage.removeItem(v),null):(console.log(`Loaded ${t.sections.length} sections from cache (version: ${t.version||"unknown"})`),t.sections)}catch(e){return console.warn("Failed to load sections from cache:",e),localStorage.removeItem(v),null}}function ue(){localStorage.removeItem(v),console.log("Sections cache cleared")}async function q(){try{let e=me();return e||(console.log("No cached sections found or cache expired, loading from API..."),e=await D(),e&&e.length>0?(de(e),e):(console.warn("No sections returned from API"),[]))}catch(e){throw console.error("Failed to load sections from cache or API:",e),e}}const w={DOTS:"dots",RING:"ring",GRADIENT:"gradient"};let B=w.DOTS;function fe(e){Object.values(w).includes(e)?(B=e,console.log(`Loading animation set to: ${e}`)):console.warn(`Invalid spinner type: ${e}. Using default: ${B}`)}function j(e="Loading...",t=B){const n=document.getElementById("loading-overlay");if(!n){console.warn("Loading overlay not found, creating fallback spinner"),pe(e);return}const o=n.querySelector(".loading-text"),s=n.querySelector("#spinner-container");if(o&&(o.textContent=e),s){s.innerHTML="";const r=ge(t);s.appendChild(r)}n.style.display="flex",n.style.opacity="0",setTimeout(()=>{n.style.opacity="0.9"},50)}function F(){const e=document.getElementById("loading-overlay");if(!e){const t=document.getElementById("fallback-spinner");t&&document.body.removeChild(t);return}e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300)}function pe(e){if(document.getElementById("fallback-spinner"))return;const n=document.createElement("div");n.id="fallback-spinner",n.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column;",n.innerHTML=`<div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem;"></div><div style="color: #6c757d; font-size: 0.9rem;">${e}</div>`,document.body.appendChild(n)}function ge(e){const t=document.createElement("div");switch(e){case w.DOTS:t.className="modern-spinner";break;case w.RING:t.className="ring-spinner";break;case w.GRADIENT:t.className="gradient-spinner";break;default:t.className="modern-spinner"}return t}function b(e){const t=document.createElement("div");t.className="error-toast",t.innerHTML=`<div class="error-toast-content"><i class="fas fa-exclamation-circle"></i><span>${e}</span><button class="error-toast-close">&times;</button></div>`,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},5e3),t.querySelector(".error-toast-close").addEventListener("click",()=>{t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)})}function he(e,t){let n=document.getElementById("sections-table-container");if(!n)return;let o='<div class="mb-3"><div class="d-flex justify-content-end mb-2"><button class="btn btn-outline-secondary btn-sm" onclick="clearSectionsCache(); loadSectionsFromCacheOrAPI();" title="Refresh sections from API"><i class="fas fa-sync"></i></button></div><table id="sections-table" class="table table-striped table-sm"><thead><tr><th style="width: 40px;"></th><th>Section Name</th></tr></thead><tbody>';e.forEach(r=>{const c=r.sectionid||r.id||"unknown",a=r.sectionname||r.name||"Unknown Section";o+=`<tr><td><input type="checkbox" class="section-checkbox" value="${c}"></td><td>${a}</td></tr>`}),o+="</tbody></table></div>",n.innerHTML=o,n.querySelectorAll(".section-checkbox").forEach(r=>{r.addEventListener("change",()=>{const c=Array.from(n.querySelectorAll(".section-checkbox:checked")).map(a=>a.value);if(c.length>0)t(c);else{const a=document.getElementById("events-table-container");a&&(a.innerHTML='<div class="text-center text-muted py-3"><i class="fas fa-calendar-alt"></i><p class="mb-0 mt-2">Select sections to view events</p></div>')}})})}function be(e,t,n=!1){let o=document.getElementById("events-table-container");if(!o)return;const s=window.innerWidth<=767||n;let r;s?(r='<div class="table-responsive"><table id="events-table" class="table table-striped table-sm"><thead><tr><th style="width: 40px;"></th><th style="width: 70px;" class="text-center">Total</th><th>Event Details</th><th style="width: 40px;"><i class="fas fa-expand-alt" title="Tap rows to expand"></i></th></tr></thead><tbody>',e.forEach((a,l)=>{const i=a.yes||0,d=a.no||0;r+=`<tr>
                <td><input type="checkbox" class="event-checkbox" data-idx="${l}"></td>
                <td class="text-center">
                    <div class="d-flex flex-column">
                        <span class="text-success fw-bold">${i}</span>
                        <span class="text-danger small">${d}</span>
                    </div>
                </td>
                <td>
                    <div class="fw-bold">${a.name||""}</div>
                    <small class="text-muted">${a.sectionname||""}</small>
                    <br><small class="text-muted">${a.date||""}</small>
                </td>
                <td class="text-center">
                    <span class="expand-icon">▼</span>
                </td>
            </tr>`})):(r='<div class="table-responsive"><table id="events-table" class="table table-striped table-sm"><thead><tr><th style="width: 40px;"></th><th style="min-width: 120px;" data-sort="sectionname">Section</th><th style="min-width: 150px;" data-sort="name">Event Name</th><th style="min-width: 100px;" data-sort="date">Date</th><th style="min-width: 60px;" data-sort="yes">Yes</th><th style="min-width: 80px;" data-sort="yes_members">Members</th><th style="min-width: 60px;" data-sort="yes_yls">YLs</th><th style="min-width: 80px;" data-sort="yes_leaders">Leaders</th><th style="min-width: 60px;" data-sort="no">No</th></tr></thead><tbody>',e.forEach((a,l)=>{r+=`<tr>
                <td><input type="checkbox" class="event-checkbox" data-idx="${l}"></td>
                <td class="text-nowrap">${a.sectionname||""}</td>
                <td class="event-name-cell">${a.name||""}</td>
                <td class="text-nowrap">${a.date||""}</td>
                <td class="text-center">${a.yes||0}</td>
                <td class="text-center">${a.yes_members||0}</td>
                <td class="text-center">${a.yes_yls||0}</td>
                <td class="text-center">${a.yes_leaders||0}</td>
                <td class="text-center">${a.no||0}</td>
            </tr>`})),r+="</tbody></table></div>",o.innerHTML=r,o.eventsData=e,o.querySelectorAll(".event-checkbox").forEach(a=>{a.addEventListener("change",()=>{const l=Array.from(o.querySelectorAll(".event-checkbox:checked")).map(i=>e[parseInt(i.dataset.idx)]);l.length>0&&t(l)})})}function ye(){const e=document.querySelector("main");if(!e){console.error("Main container not found");return}if(e.innerHTML='<div class="container-fluid p-0"><div class="row no-gutters"><div class="col-12"><div id="app-content"><div id="attendance-panel" class="mt-4"><div class="card shadow-sm h-100"><div class="card-header bg-info text-white"><h5 class="mb-0">Attendance Details</h5></div><div class="card-body"><p class="text-muted text-center">Use the sidebar to load sections and events, then view attendance details here.</p></div></div></div></div></div></div></div>',ve(),!document.querySelector(".sidebar-content")){console.warn("Sidebar content not found, recreating...");const n=document.getElementById("sidebar");n&&(n.innerHTML='<div class="sidebar-header"><h3>Sections & Events</h3></div><div class="sidebar-content"><div id="sections-table-container"></div><div id="events-table-container" class="mt-3"></div></div>')}Se(),console.log("Main UI initialized - ready for sidebar interaction")}function ve(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarToggle"),n=document.getElementById("sidebarOverlay");if(!e||!t){console.warn("Sidebar elements not found for initialization.");return}function o(){e.classList.remove("open"),document.body.classList.remove("sidebar-open"),n&&n.classList.remove("show"),t.style.left="1rem"}t.addEventListener("click",()=>{e.classList.contains("open")?o():(e.classList.add("open"),document.body.classList.add("sidebar-open"),n&&n.classList.add("show"),t.style.left="340px")}),n&&n.addEventListener("click",o),document.addEventListener("click",s=>{e.classList.contains("open")&&!e.contains(s.target)&&s.target!==t&&!t.contains(s.target)&&o()}),document.addEventListener("keydown",s=>{s.key==="Escape"&&e.classList.contains("open")&&o()})}function I(){const e=document.getElementById("sidebarToggle");if(e){const t=document.body.classList.contains("login-screen");console.log("Updating sidebar toggle visibility:",{isLoginScreen:t,element:e}),e.style.display=t?"none":"block"}}function V(){var t;const e=document.querySelector("main.container")||document.querySelector("main");if(!e){console.error("Main container not found for blocked screen");return}document.body.classList.add("login-screen"),I(),e.style.display="block",e.className="container",e.innerHTML=`<div class="row justify-content-center"><div class="col-12 col-sm-10 col-md-8 col-lg-6"><div class="card shadow border-danger mb-4"><div class="card-header bg-danger text-white text-center"><h3 class="mb-0">🚨 CRITICAL ERROR</h3></div><div class="card-body text-center p-4"><div class="alert alert-danger mb-4"><h4 class="alert-heading">API Access Blocked!</h4><p class="mb-0">This application has been <strong>blocked by Online Scout Manager</strong> and can no longer access OSM data.</p></div><div class="mb-4"><i class="fas fa-ban text-danger" style="font-size: 4rem;"></i></div><h5 class="text-danger mb-3">Application Suspended</h5><p class="text-muted mb-4">All API functionality has been disabled. <strong>Contact admin.</strong></p><div class="bg-light p-3 rounded mb-4"><small class="text-muted"><strong>Blocked at:</strong> ${new Date().toLocaleString()}<br><strong>Session ID:</strong> ${((t=sessionStorage.getItem("access_token"))==null?void 0:t.substring(0,12))||"N/A"}...</small></div><button onclick="alert('Application is blocked. Contact administrator.')" class="btn btn-danger btn-lg disabled mb-3"><i class="fas fa-ban me-2"></i>Application Blocked</button><div class="mt-3"><small class="text-muted"><a href="#" onclick="if(confirm('Clear blocked status?')) { sessionStorage.removeItem('osm_blocked'); window.location.reload(); }" class="text-secondary">Admin: Clear Blocked Status</a></small></div></div></div></div></div>`}function we(){const e=document.querySelector("main.container")||document.querySelector("main");if(!e){console.error("Main container not found for loading state");return}e.style.display="block",e.innerHTML='<div class="row justify-content-center"><div class="col-12 col-sm-8 col-md-6 col-lg-4"><div class="card shadow-sm mb-4"><div class="card-body text-center"><div class="spinner-border text-primary mb-3" role="status"><span class="sr-only">Loading...</span></div><p class="text-muted">Loading application...</p></div></div></div></div>'}const R={DEV:!1},A="x7hx1M0NExVdSiksH1gUBPxkSTn8besx",C="section:member:read section:programme:read section:event:read section:flexirecord:write";function x(){return sessionStorage.getItem("access_token")}function Ee(e){return!(e&&(e.status===!1&&e.error&&e.error.code==="access-error-2"||e.error==="Invalid access token"||e.message==="Unauthorized"||e.error==="Token expired"))}function y(){if(console.log("Token expired - redirecting to login"),sessionStorage.removeItem("access_token"),localStorage.removeItem("viking_sections_cache"),typeof jest<"u"||typeof window<"u"&&window.navigator&&window.navigator.userAgent==="jsdom"){console.log("Test environment detected - skipping alert and page reload");return}typeof window<"u"&&window.alert&&alert("Your session has expired. Please log in again."),typeof window<"u"&&window.location&&window.location.reload()}function xe(){sessionStorage.removeItem("access_token"),console.log("Authentication token cleared")}function P(){console.log("Showing login screen");const e=R||{},t=e.VITE_API_URL||"https://vikings-osm-event-manager.onrender.com",n=e.VITE_NODE_ENV==="development"||e.DEV||typeof window<"u"&&window.location.hostname==="localhost",o=window.location.hostname!=="localhost",s=o?"prod":"dev";console.log("🧪 TEMPORARY: Forced state detection:",{forceProduction:o,stateParam:s}),console.log("🔍 OAuth Debug Info:",{currentDomain:typeof window<"u"?window.location.origin:"unknown",hostname:typeof window<"u"?window.location.hostname:"unknown",isDevelopment:n,stateParam:s,apiUrl:t,env:{VITE_NODE_ENV:e.VITE_NODE_ENV,DEV:e.DEV}});const r="https://vikings-osm-event-manager.onrender.com",c=`${r}/oauth/callback`,a=window.location.hostname==="vikings-eventmgmt.onrender.com",l=a?"prod":"dev";console.log("🔧 FORCED OAuth Config:",{hostname:window.location.hostname,isProduction:a,stateParam:s,redirectUri:c,backendUrl:r});const i=`https://www.onlinescoutmanager.co.uk/oauth/authorize?client_id=${A}&redirect_uri=${encodeURIComponent(c)}&state=${s}&scope=${encodeURIComponent(C)}&response_type=code`;console.log("🔗 Generated OAuth URL:",i),console.log("📍 Redirect URI sent to OSM:",c),console.log("🏷️ State parameter:",s);const d=document.getElementById("osm-login-btn");if(d){const f=document.querySelector("main.container")||document.querySelector("main");f&&(f.style.display="block"),d.addEventListener("click",()=>{const p=`https://www.onlinescoutmanager.co.uk/oauth/authorize?client_id=${A}&redirect_uri=${encodeURIComponent(c)}&state=${l}&scope=${encodeURIComponent(C)}&response_type=code`;console.log("🔗 FORCED OAuth URL:",p),window.location.href=p});return}const m=document.querySelector("main.container")||document.querySelector("main");if(!m){console.error("Main container not found for login screen");return}m.style.display="block",m.className="container",m.innerHTML=`
        <div class="row justify-content-center">
            <div class="col-12 col-sm-8 col-md-6 col-lg-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <button id="osm-login-btn"
                            class="btn btn-primary btn-lg mb-3"
                            style="font-size:1.5em; white-space: normal; line-height: 1.2;">
                            Login with<br>Online Scout Manager (OSM)
                        </button>
                        <div id="app-content"></div>
                    </div>
                </div>
            </div>
        </div>
    `;const u=document.getElementById("osm-login-btn");u&&u.addEventListener("click",()=>{const f=`https://www.onlinescoutmanager.co.uk/oauth/authorize?client_id=${A}&redirect_uri=${encodeURIComponent(c)}&state=${s}&scope=${encodeURIComponent(C)}&response_type=code`;window.location.href=f})}async function ke(){console.log("Checking for token...");const e=x();if(console.log("getToken() returned:",e?"Token found":"No token found"),sessionStorage.getItem("osm_blocked")==="true"){console.error("🚨 Application is blocked - showing blocked screen"),V();return}we();try{e?(console.log("Token found, testing validity..."),await D(),console.log("Token is valid, showing main UI"),document.body.classList.remove("login-screen"),I(),ye()):(console.log("No token found, showing login"),document.body.classList.add("login-screen"),I(),P())}catch(t){console.error("Token validation failed:",t),sessionStorage.removeItem("access_token"),document.body.classList.add("login-screen"),I(),P()}}function Se(){const e=document.querySelector(".sidebar-content");if(e&&!document.getElementById("logout-btn")){const t=document.createElement("button");t.id="logout-btn",t.className="btn btn-outline-danger btn-sm w-100 mt-3",t.innerHTML='<i class="fas fa-sign-out-alt"></i> Logout',t.onclick=()=>{confirm("Are you sure you want to logout?")&&(xe(),window.location.reload())},e.appendChild(t)}}const $e=()=>{const e=R||{},t=e.VITE_API_URL||"https://vikings-osm-event-manager.onrender.com";return e.VITE_NODE_ENV==="production"&&t.includes("env=dev")?t.replace(/[?&]env=dev/,""):t};$e();const _=R||{};_.VITE_NODE_ENV==="production"&&console.log("OAuth Config:",{clientId:_.VITE_OSM_CLIENT_ID?"SET":"MISSING",redirectUri:_.VITE_OSM_REDIRECT_URI,currentDomain:typeof window<"u"?window.location.origin:"unknown"});console.log("Environment Debug:",{NODE_ENV:void 0,VITE_NODE_ENV:void 0,VITE_API_URL:void 0,currentURL:window.location.href,isProduction:!1});console.log("🚀 Auth.js loaded - Version 3.0 - TIMESTAMP: 2025-01-23-18:00");const Ie="ring";try{window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"&&K(()=>import("./sentry-CPVx-NBJ.js"),[]).catch(e=>{console.warn("Sentry initialization failed:",e)})}catch(e){console.warn("Error monitoring not available:",e)}let N=[];document.addEventListener("DOMContentLoaded",async function(){try{const t=sessionStorage.getItem("access_token");console.log("Token check on page load:",t?"Token found":"No token found"),console.log("SessionStorage contents:",{access_token:sessionStorage.getItem("access_token"),token_type:sessionStorage.getItem("token_type"),osm_access_token:sessionStorage.getItem("osm_access_token")});const n=document.querySelector("main.container")||document.querySelector("main");if(n&&(n.style.display="none"),fe(Ie),!n){console.error("Critical: Main container not found. App cannot start.");return}if(console.log("Calling checkForToken..."),await ke(),!document.body.classList.contains("login-screen")){const o=document.getElementById("sections-table-container");o&&(o.innerHTML='<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> <small class="text-muted ms-2">Loading sections...</small></div>');try{const s=await q();s?(N=s,he(N,r=>{ie(r,N)})):o&&(o.innerHTML='<div class="alert alert-info">No sections found or an issue occurred.</div>')}catch(s){console.error("Error loading sections in main.js:",s),o?o.innerHTML='<div class="alert alert-danger alert-sm"><i class="fas fa-exclamation-triangle"></i> Failed to load sections. <button class="btn btn-outline-primary btn-sm float-end" onclick="window.location.reload()">Retry</button></div>':b("Failed to load sections data. Please try refreshing.")}}}catch(t){console.error("App initialization failed:",t),Le()}});function Le(){const e=document.body;if(e){const t=document.createElement("div");t.innerHTML=`
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        text-align: center; max-width: 400px;">
                <h3 style="color: #dc3545; margin-bottom: 1rem;">Application Error</h3>
                <p style="margin-bottom: 1.5rem;">Failed to load the application. Please refresh the page.</p>
                <button onclick="window.location.reload()" 
                        style="padding: 0.75rem 1.5rem; background: #007bff; color: white; 
                               border: none; border-radius: 4px; cursor: pointer;">
                    Refresh Page
                </button>
            </div>
        `,e.appendChild(t)}}window.switchAttendanceTab=re;window.clearSectionsCache=ue;window.loadSectionsFromCacheOrAPI=q;
//# sourceMappingURL=main-oVuMctXz.js.map
